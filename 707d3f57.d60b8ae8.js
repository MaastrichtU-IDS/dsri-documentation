(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{100:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return c})),a.d(t,"rightToc",(function(){return p})),a.d(t,"default",(function(){return b}));var n=a(3),o=a(7),r=(a(0),a(147)),i=["components"],l={id:"deploy-on-gpu",title:"GPU applications"},c={unversionedId:"deploy-on-gpu",id:"deploy-on-gpu",isDocsHomePage:!1,title:"GPU applications",description:"By default you do not have the permission to run pods on GPU",source:"@site/docs/deploy-on-gpu.md",slug:"/deploy-on-gpu",permalink:"/dsri-documentation/docs/deploy-on-gpu",editUrl:"https://github.com/MaastrichtU-IDS/dsri-documentation/edit/master/website/docs/deploy-on-gpu.md",version:"current",lastUpdatedBy:"Vincent Emonet",lastUpdatedAt:1638961031,sidebar:"docs",previous:{title:"Imaging softwares",permalink:"/dsri-documentation/docs/catalog-imaging"},next:{title:"Utilities",permalink:"/dsri-documentation/docs/catalog-utilities"}},p=[{value:"Start a workspace on GPU",id:"start-a-workspace-on-gpu",children:[{value:"TensorBoard logs visualization",id:"tensorboard-logs-visualization",children:[]},{value:"Increase the number of GPUs in your workspace",id:"increase-the-number-of-gpus-in-your-workspace",children:[]}]},{value:"Install GPU drivers in any image",id:"install-gpu-drivers-in-any-image",children:[]},{value:"Prepare your GPU workspace",id:"prepare-your-gpu-workspace",children:[]},{value:"Reserve GPU for your experiments",id:"reserve-gpu-for-your-experiments",children:[]}],s={rightToc:p};function b(e){var t=e.components,a=Object(o.a)(e,i);return Object(r.b)("wrapper",Object(n.a)({},s,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Request GPU access")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},Object(r.b)("strong",{parentName:"p"},"By default you do not have the permission to run pods on GPU")," "),Object(r.b)("p",{parentName:"div"},"If you want to run on GPU, ",Object(r.b)("strong",{parentName:"p"},"contact the ",Object(r.b)("a",{parentName:"strong",href:"mailto:dsri-support-l@maastrichtuniversity.nl"},"DSRI support team")),", they will create the templates you need to start applications on GPU."))),Object(r.b)("p",null,"We are using images provided by Nvidia, and optimized for GPU. We currently deployed Tensorflow and PyTorch with JupyterLab and VSCode, but any image available in the Nvidia catalog should be easy to deploy: ",Object(r.b)("a",{parentName:"p",href:"https://ngc.nvidia.com/catalog/containers"},"https://ngc.nvidia.com/catalog/containers")),Object(r.b)("p",null,"Checkout ",Object(r.b)("a",{parentName:"p",href:"https://github.com/MaastrichtU-IDS/jupyterlab#jupyterlab-on-gpu"},"this documentation")," for more details on how we build the optimized docker images for the DSRI GPUs. Feel free to ",Object(r.b)("a",{parentName:"p",href:"https://github.com/MaastrichtU-IDS/jupyterlab#extend-an-image"},"extend the images")," to your needs."),Object(r.b)("h2",{id:"start-a-workspace-on-gpu"},"Start a workspace on GPU"),Object(r.b)("p",null,"Start a workspace in your DSRI project based on Ubuntu, with all drivers and dependencies for accessing the GPU already installed. You will be able to access it using the JupyterLab web UI and VisualStudio Code in the browser."),Object(r.b)("p",null,"Once your project has been granted access to GPUs, you can deploy applications on GPU from the catalog:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Go to the ",Object(r.b)("a",{parentName:"li",href:"https://console-openshift-console.apps.dsri2.unimaas.nl/console/catalog"},"Catalog web UI"),": ",Object(r.b)("strong",{parentName:"li"},"Add to Project")," > ",Object(r.b)("strong",{parentName:"li"},"Browse Catalog")),Object(r.b)("li",{parentName:"ol"},'Filter the catalog for  "GPU"'),Object(r.b)("li",{parentName:"ol"},"Choose one of the available templates: ",Object(r.b)("strong",{parentName:"li"},"JupyterLab on GPU"),"."),Object(r.b)("li",{parentName:"ol"},Object(r.b)("strong",{parentName:"li"},"Follow the instructions")," to create the template in the DSRI web UI, all informations about the images you can use are provided there.")),Object(r.b)("p",null,"You can find more details on the images we use and how to extend them in this repository: ",Object(r.b)("a",{parentName:"p",href:"https://github.com/MaastrichtU-IDS/jupyterlab#jupyterlab-on-gpu"},"https://github.com/MaastrichtU-IDS/jupyterlab#jupyterlab-on-gpu")),Object(r.b)("p",null,"Once your template is created, wait a few seconds before it becomes accessible from the ",Object(r.b)("strong",{parentName:"p"},"Topology")," page of OpenShift web UI, you can access the JupyterLab web UI, install your dependencies and run your experiments."),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Storage")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"Use the ",Object(r.b)("strong",{parentName:"p"},Object(r.b)("inlineCode",{parentName:"strong"},"/workspace/persistent")," folder"),", which is the JupyterLab workspace, to store your code and data persistently. Note that loading data from the persistent storage will be slowly that what you might expected, this is due to the nature of the distributed storage. So try to optimize this part and avoid reloading multiple time your data, and let us know if it is too much of a problem, we have some solution to improve this"))),Object(r.b)("p",null,"You can use the following command in the terminal to see your current GPU usage:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"nvidia-smi\n")),Object(r.b)("h3",{id:"tensorboard-logs-visualization"},"TensorBoard logs visualization"),Object(r.b)("p",null,"When using Tensorflow, you can use ",Object(r.b)("a",{parentName:"p",href:"https://www.tensorflow.org/tensorboard"},Object(r.b)("strong",{parentName:"a"},"TensorBoard \ud83d\udcc8"))," to explore your machine learning runs. It should be already pre-installed in our JupyterLab for GPU templates."),Object(r.b)("p",null,"Follow the usual process to run tensorboard: ",Object(r.b)("a",{parentName:"p",href:"https://www.tensorflow.org/tensorboard/get_started"},"https://www.tensorflow.org/tensorboard/get_started")),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Add the tensorboard callback to your ",Object(r.b)("inlineCode",{parentName:"p"},"model.fit()")," function")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Then start Tensorboard in the terminal with ",Object(r.b)("inlineCode",{parentName:"p"},"tensorboard --logdir logs")," (change the directory depending on where the logs of your runs are stored), it should tell you that tensorboard as been started on port 6006")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Open the Tensorboard view from the JupyterLab welcome page"))),Object(r.b)("h3",{id:"increase-the-number-of-gpus-in-your-workspace"},"Increase the number of GPUs in your workspace"),Object(r.b)("p",null,"If you already have a application running using 1 GPU, and you have been granted a 2nd GPU to speed up your experiment you can easily upgrade the number of GPU used by your application:"),Object(r.b)("p",null,"From the ",Object(r.b)("strong",{parentName:"p"},"Topology")," view click on your application:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Stop the application, by decreasing the number of pod to 0 (in the ",Object(r.b)("strong",{parentName:"li"},"Details")," tab)"),Object(r.b)("li",{parentName:"ol"},"Click on ",Object(r.b)("strong",{parentName:"li"},"Options")," > ",Object(r.b)("strong",{parentName:"li"},"Edit Deployment")," > in the YAML of the deployment search for ",Object(r.b)("inlineCode",{parentName:"li"},"limits")," and change the number of GPU assigned to your deployment to 2:")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},"          resources:\n            limits:\n              nvidia.com/gpu: '2'\n            requests:\n              nvidia.com/gpu: '2'\n")),Object(r.b)("p",null,"You can also do it using the command line, make sure to stop the pod first, and replace ",Object(r.b)("inlineCode",{parentName:"p"},"jupyterlab-gpu")," by your app name in this command:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'oc patch dc/jupyterlab-gpu --type=json -p=\'[{"op": "replace", "path": "/spec/template/spec/containers/0/resources", "value": {"requests": {"nvidia.com/gpu": 2}, "limits": {"nvidia.com/gpu": 2}}}]\'\n')),Object(r.b)("ol",{start:3},Object(r.b)("li",{parentName:"ol"},"Restart the pod for your application (the same way you stopped it)")),Object(r.b)("h2",{id:"install-gpu-drivers-in-any-image"},"Install GPU drivers in any image"),Object(r.b)("p",null,"See the latest official ",Object(r.b)("a",{parentName:"p",href:"https://nvidia.github.io/nvidia-container-runtime"},"Nvidia docs")," to install the ",Object(r.b)("inlineCode",{parentName:"p"},"nvidia-container-runtime")," (all packages and drivers required to access the GPU from your application)"),Object(r.b)("p",null,"Here is an example of commands to add to a debian based ",Object(r.b)("inlineCode",{parentName:"p"},"Dockerfile")," to install the GPU drivers:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-dockerfile"},"RUN curl -s -L https://nvidia.github.io/nvidia-container-runtime/gpgkey | \\\n    apt-key add - \\ &&\n    distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \\ &&\n    curl -s -L https://nvidia.github.io/nvidia-container-runtime/$distribution/nvidia-container-runtime.list | \nRUN apt-get update \\ &&\n    apt-get install -y nvidia-container-runtime\n")),Object(r.b)("p",null,"Then, build your image in your DSRI project using ",Object(r.b)("inlineCode",{parentName:"p"},"oc")," from the folder where your put the ",Object(r.b)("inlineCode",{parentName:"p"},"Dockerfile")," (replace ",Object(r.b)("inlineCode",{parentName:"p"},"custom-app-gpu")," by your app name):"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"oc new-build --name custom-app-gpu --binary\noc start-build custom-app-gpu --from-dir=. --follow --wait\noc new-app custom-app-gpu\n")),Object(r.b)("p",null,"You will then need to edit the deployment to add the GPU NodeSelector, the ",Object(r.b)("inlineCode",{parentName:"p"},"serviceAccountName: anyuid")," and add a persistent storage"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"oc edit custom-app-gpu\n")),Object(r.b)("p",null,"See also: official ",Object(r.b)("a",{parentName:"p",href:"https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#debian-installation"},"Nvidia docs for CUDA")),Object(r.b)("h2",{id:"prepare-your-gpu-workspace"},"Prepare your GPU workspace"),Object(r.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Experimental")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"Experimental: this workflow is still experimental, let us know on Slack #helpdesk if you are interested in using it and helping us improve it."))),Object(r.b)("p",null,"Start a GPU application from the template with ",Object(r.b)("inlineCode",{parentName:"p"},"0")," GPU set."),Object(r.b)("p",null,"Access the workspace like you would normally, add your code and data."),Object(r.b)("p",null,"Once the GPU quotas has been granted to your project, you can update your deployment to use the GPUs using this command (our deployment name is ",Object(r.b)("inlineCode",{parentName:"p"},"jupyterlab-gpu")," in this example, change it to yours)"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'oc patch dc/jupyterlab-gpu --type=json -p=\'[{"op": "replace", "path": "/spec/template/spec/containers/0/resources", "value": {"requests": {"nvidia.com/gpu": 1}, "limits": {"nvidia.com/gpu": 1}}}]\'\n')),Object(r.b)("p",null,"Later you can remove the GPU from your app without stopping it:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'oc patch dc/jupyterlab-gpu --type=json -p=\'[{"op": "replace", "path": "/spec/template/spec/containers/0/resources", "value": {"requests": {"nvidia.com/gpu": 0}, "limits": {"nvidia.com/gpu": 0}}}]\'\n')),Object(r.b)("h2",{id:"reserve-gpu-for-your-experiments"},"Reserve GPU for your experiments"),Object(r.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Experimental")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"Still experimental."))),Object(r.b)("p",null,"You can check the availability of the 8 GPUs of the DSRI through the Maastricht University Outlook Calendar:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Go to the your UM Outlook Calendar (through the desktop or web application)"),Object(r.b)("li",{parentName:"ol"},'Create a new Calendar group named "DSRI GPUs"'),Object(r.b)("li",{parentName:"ol"},"Add the 8 ",Object(r.b)("inlineCode",{parentName:"li"},"EQUIP-PHS1-DSRIGPU")," numbered from 1 to 8, e.g. ",Object(r.b)("inlineCode",{parentName:"li"},"EQUIP-PHS1-DSRIGPU1-1P")," to this Calendar Group. This way you will be able to quickly see when a GPU is free or reserved")),Object(r.b)("p",null,"To reserve a GPU directly in the Calendar:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Check for a GPU available in the period when you will need to use it"),Object(r.b)("li",{parentName:"ul"},"Create an event for the period you expect you will need the GPU:",Object(r.b)("ul",{parentName:"li",className:"contains-task-list"},Object(r.b)("li",{parentName:"ul",className:"task-list-item"},Object(r.b)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Put your the GPU number, and your DSRI project ID where we will add the GPU in the title, e.g. ",Object(r.b)("inlineCode",{parentName:"li"},"GPU 3 for your-project-id")),Object(r.b)("li",{parentName:"ul",className:"task-list-item"},Object(r.b)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ",'Set the Duration to "',Object(r.b)("strong",{parentName:"li"},"Full day"),'"'),Object(r.b)("li",{parentName:"ul",className:"task-list-item"},Object(r.b)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Ideally ",Object(r.b)("strong",{parentName:"li"},"reserve a week")," (or more) from ",Object(r.b)("strong",{parentName:"li"},"Monday to Monday")),Object(r.b)("li",{parentName:"ul",className:"task-list-item"},Object(r.b)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Don't hold the GPU for too long, other people needs it at UM! You can reserve it again later"),Object(r.b)("li",{parentName:"ul",className:"task-list-item"},Object(r.b)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add the following users as ",Object(r.b)("strong",{parentName:"li"},"Attendees"),": ",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"vincent.emonet@maastrichtuniversity.nl")," "),Object(r.b)("li",{parentName:"ul"},"the ",Object(r.b)("inlineCode",{parentName:"li"},"EQUIP-PHS1-DSRIGPU")," email address of the GPU you want to reserve"))))),Object(r.b)("li",{parentName:"ul"},"You should receive an email telling you if the reservation has been successful",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"This does not mean your reservation is completely validated, we will let you know through Slack or email if the reservation needs to be changed.")))),Object(r.b)("p",null,"It is not mandatory to create the reservation in the Calendar, feel free to contact us on Slack or via email to make the reservation directly with us."))}b.isMDXComponent=!0},147:function(e,t,a){"use strict";a.d(t,"a",(function(){return b})),a.d(t,"b",(function(){return m}));var n=a(0),o=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=o.a.createContext({}),s=function(e){var t=o.a.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},b=function(e){var t=s(e.components);return o.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},u=o.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=s(a),u=n,m=b["".concat(i,".").concat(u)]||b[u]||d[u]||r;return a?o.a.createElement(m,l(l({ref:t},p),{},{components:a})):o.a.createElement(m,l({ref:t},p))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var p=2;p<r;p++)i[p]=a[p];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);